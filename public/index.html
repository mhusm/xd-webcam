<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">

    <!-- 1. Load platform support before any code that touches the DOM. -->
    <!--    <script src="http://129.132.114.114/js/remote.js"></script>  -->
    <script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <link rel="import" href="bower_components/polymer/polymer.html">
    <!-- 2. Load the component using an HTML Import -->

    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-synchronised.html">
    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-connect.html">
    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-connection.html">
    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-url-pairing.html">
    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-qr.html">

    <link rel="import" href="bower_components/xdmvcclient/layouts/controller-layout.html">
    <meta name="viewport" content="width=device-width, user-scalable=no">

    <title></title>
</head>
<body>
<style>
    html,body {
        font-family: 'RobotoDraft', sans-serif;
        padding: 0;
        margin: 0;
        overflow: hidden;
    }

</style>

<dom-module id="my-app">
    <template>
        <xdmvc-connection ></xdmvc-connection>

        <xdmvc-synchronised id="sync"
                            objects='{{synced}}'
                            other-devices="{{others}}">
        </xdmvc-synchronised>
         <controller-layout>
            <div class="controller">
this is the phone
                <button on-click="goBack">Go back</button>
                <button on-click="setPilatus">Pilatus</button>

                <button on-click="setWS">Wildspitz</button>
                <button on-click="goLeft">Go left</button>
                <button on-click="goRight">Go right</button>
                <xdmvc-url-pairing connector="controller" connectee="viewer" ></xdmvc-url-pairing>

            </div>
            <div class="viewer">
                <div id="qr">
                    <xdmvc-url-pairing connector="controller" connectee="viewer"  url="{{url}}"></xdmvc-url-pairing>
                    <xdmvc-qr url="[[url]]" message="Scan the QR code to pair to this screen."></xdmvc-qr>
                </div>

                <img id="image" src="[[src]]" on-error="imageError"/>
            </div>
        </controller-layout>
        <style>

            img {
                height: 100vh;
                position: absolute;


            }
            #qr {
                position: absolute;
            }
        </style>

   </template>
</dom-module>
<script>

  function pad(num, size){ return ('0' + num).substr(-size); }

  HTMLImports.whenReady(function () {

      Polymer({
          is: "my-app",
          properties: {
              cameras: {
                  type: Object,
                   value: function(){ return  {
                        pilatus: "53ce6af5ae1835.21533240",
                        wildspitz: "5595515f75aba9.83008277"
                   }}
               },

              synced: {
                  type: Object,
                  value: function(){ return { time: { ms: Date.now()   },
                      camera : { location: "wildspitz"},
                      position: {left: 0}
                  }} ,
                  notify: true
              },
               src: String
        },
          observers: ["setTime(synced.time.ms, synced.camera.location)",
                      "setPosition(synced.position.left)"
          ],

          ready: function () {
              this.setTime(Date.now());
              setInterval(this.setNow.bind(this), 10*60*1000)
          },
          imageError: function (e) {
              console.log(e);
              this.goBack(); // go back in time until we find a photo
              // should maybe stop at some point?
          },
          setNow: function() {
                this.setTime(Date.now());
          },

          goBack: function() {
              // Try 10 minutes before
              this.setTime(this.synced.time.ms -10*60*1000);
          },
          goForward: function() {
              // Try 10 minutes before
              this.setTime(this.synced.time.ms +10*60*1000);
              // should maybe stop at some point?
          },

          setPilatus: function() {
              this.set("synced.camera.location", "pilatus");
          },
          setWS: function() {
              this.set("synced.camera.location", "wildspitz");
          },

          goLeft: function () {
              this.set("synced.position.left", this.synced.position.left -1);
          },
          goRight: function () {
              this.set("synced.position.left", this.synced.position.left +1);
          },

          setPosition: function() {
              this.$$("#image").style.left = this.synced.position.left +"vw";
          },

          setTime: function(time) {
              this.set("synced.time.ms", time);
              const tenMinutesAgo = new Date(this.synced.time.ms - 10*60*1000);
              const date = `${tenMinutesAgo.getFullYear()}-${pad(tenMinutesAgo.getMonth()+1,2)}-${pad(tenMinutesAgo.getDate(),2)}`;
              // minutes must be multiples of 10
              const timeformat = `${pad(tenMinutesAgo.getHours(),2)}-${pad(Math.floor((tenMinutesAgo.getMinutes())/10)*10,2)}-00`;
              console.log(date +"-" +timeformat);
              console.log(this.cameras);
              this.src = `http://storage.roundshot.com/${this.cameras[this.synced.camera.location]}/${date}/${timeformat}/${date}-${timeformat}_full.jpg`;
          }

      });
  });

</script>

<my-app></my-app>


</body>
</html>
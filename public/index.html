<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">

    <!-- 1. Load platform support before any code that touches the DOM. -->
    <!--    <script src="http://129.132.114.114/js/remote.js"></script>  -->
    <script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <link rel="import" href="bower_components/polymer/polymer.html">
    <!-- 2. Load the component using an HTML Import -->

    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-synchronised.html">
    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-connect.html">
    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-connection.html">
    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-url-pairing.html">
    <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-qr.html">
    <link rel="import" href="bower_components/iron-selector/iron-selector.html">

    <link rel="import" href="bower_components/xdmvcclient/layouts/controller-layout.html">
    <meta name="viewport" content="width=device-width, user-scalable=no">

    <title></title>
</head>
<body>
<style>
    html,body {
        font-family: 'RobotoDraft', sans-serif;
        padding: 0;
        margin: 0;
        overflow: hidden;
    }

</style>

<dom-module id="my-app">
    <template>
        <xdmvc-connection ></xdmvc-connection>

        <xdmvc-synchronised id="sync"
                            objects='{{synced}}'
                            other-devices="{{others}}">
        </xdmvc-synchronised>
        <controller-layout>
            <div class="controller">
                <xdmvc-url-pairing connector="controller" connectee="viewer" ></xdmvc-url-pairing>
                <div id="landscape">
                    <button on-click="goBack">Go back</button>
                    <button on-click="goForward">Go forward</button>
                    <button on-click="goLeft">Go left</button>
                    <button on-click="goRight">Go right</button>
                </div>
                <div id="portrait">

                    <iron-selector selected="{{synced.camera.selected}}">

                        <template is="dom-repeat" items='[[cameras]]'>
                            <div class="camera">
                                <span>[[item.name]]</span>
                                <img src="[[getSrcForLocation(index)]]"/>
                            </div>
                        </template>

                    </iron-selector>

                </div>

            </div>
            <div class="viewer">
                <div id="qr">
                    <xdmvc-url-pairing connector="controller" connectee="viewer"  url="{{url}}"></xdmvc-url-pairing>
                    <xdmvc-qr url="[[url]]" message="Scan the QR code to pair to this screen."></xdmvc-qr>
                </div>
                <img id="image" src="[[src]]" on-error="imageError"/>
                <div>[[src]]</div>
            </div>
        </controller-layout>
        <style>

            img {
                height: 100vh;
                position: absolute;


            }
            #qr {
                position: absolute;
                z-index: 1;
            }


            .camera {
                width: 50vw;
                height: 50vw;
                display: inline-block;
                white-space: normal;
                vertical-align: top;
                overflow: hidden;
            }

            .camera img {
                position: relative;
                height: inherit;
            }

            #portrait {
                white-space: nowrap;
            }

            @media (orientation: landscape) {
                #portrait {
                    display: none;
                }
            }
            @media (orientation: portrait) {
                #landscape {
                    display: none;
                }
            }
        </style>

   </template>
</dom-module>
<script>

    function pad(num, size){ return ('0' + num).substr(-size); }

    HTMLImports.whenReady(function () {

        Polymer({
            is: "my-app",
            properties: {
                cameras: {
                    type: Array,
                    value: function(){ return  [
                       { name: "Pilatus", code: "53ce6af5ae1835.21533240" },
                       { name: "Wildspitz", code: "5595515f75aba9.83008277" }
                    ]}
                },

                synced: {
                    type: Object,
                    value: function(){ return { time: { ms: Date.now()-10*60*1000   },
                      camera : { selected: 0},
                      position: {left: 0}
                    } } ,
                    notify: true
                },
                src: String,
                selectedCamera: {
                    type: String
                },
                portrait: {
                    type: Boolean,
                    value: false
                }

            },
            observers: ["updateSrc(synced.time.ms, selectedCamera)",
                    "setPosition(synced.position.left)",
                    "selectedCameraChanged(synced.camera.selected)"
            ],

            ready: function () {
                setInterval(this.setNow.bind(this), 10*60*1000)
            },
            imageError: function (e) {
              console.log(e);
              this.goBack(); // go back in time until we find a photo
              // should maybe stop at some point?
            },
            setNow: function() {
                // Now minus ten minutes. The camera's take some time to produce the images
                this.set("synced.time.ms", Date.now()-10*60*1000);
            },

            goBack: function() {
              // Try 10 minutes before
                this.set("synced.time.ms", this.synced.time.ms -10*60*1000);
            },
            goForward: function() {
              // Try 10 minutes before
                this.set("synced.time.ms", this.synced.time.ms +10*60*1000);
              // should maybe stop at some point?
            },

            goLeft: function () {
              this.set("synced.position.left", this.synced.position.left -1);
            },
            goRight: function () {
              this.set("synced.position.left", this.synced.position.left +1);
            },

            selectedCameraChanged: function() {
                this.selectedCamera =  this.cameras[this.synced.camera.selected].code;
            },

            setPosition: function() {
              this.$$("#image").style.left = this.synced.position.left +"vw";
            },

            getSrcForLocation: function(index) {
                return this.getSrc(this.synced.time.ms, this.cameras[index].code);
            },

            updateSrc: function(time, location) {
                this.src = this.getSrc(this.synced.time.ms, this.selectedCamera);
            },

            getSrc: function(timeMs, location) {
                const time = new Date(timeMs);
                const date = `${time.getFullYear()}-${pad(time.getMonth()+1,2)}-${pad(time.getDate(),2)}`;
                // minutes must be multiples of 10
                const timeformat = `${pad(time.getHours(),2)}-${pad(Math.floor((time.getMinutes())/10)*10,2)}-00`;
                return `http://storage.roundshot.com/${location}/${date}/${timeformat}/${date}-${timeformat}_full.jpg`;
            }

        });
    });

</script>

<my-app></my-app>


</body>
</html>